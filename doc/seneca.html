<!DOCTYPE html>

<html>
<head>
  <title>seneca.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>seneca.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* Copyright (c) 2010-2015 Richard Rodger, MIT License */</span>
<span class="hljs-comment">/* jshint node:true, asi:true, eqnull:true */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <style> p,ul,li { margin:5px !important; } </style>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Current version, access using <em>seneca.version</em> property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> VERSION = <span class="hljs-string">'0.6.5'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Node API modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> util   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> net    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'net'</span>)
<span class="hljs-keyword">var</span> repl   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'repl'</span>)
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">var</span> vm     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vm'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>External modules.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> _            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)
<span class="hljs-keyword">var</span> nid          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nid'</span>)
<span class="hljs-keyword">var</span> jsonic       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonic'</span>)
<span class="hljs-keyword">var</span> patrun       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'patrun'</span>)
<span class="hljs-keyword">var</span> parambulator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'parambulator'</span>)
<span class="hljs-keyword">var</span> norma        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'norma'</span>)
<span class="hljs-keyword">var</span> stats        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rolling-stats'</span>)
<span class="hljs-keyword">var</span> makeuse      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'use-plugin'</span>)
<span class="hljs-keyword">var</span> lrucache     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lru-cache'</span>)
<span class="hljs-keyword">var</span> zig          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zig'</span>)
<span class="hljs-keyword">var</span> gex          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gex'</span>)
<span class="hljs-keyword">var</span> executor     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gate-executor'</span>)
<span class="hljs-keyword">var</span> eraro        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eraro'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Internal modules.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> make_entity   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/entity'</span>)
<span class="hljs-keyword">var</span> store         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/store'</span>)
<span class="hljs-keyword">var</span> logging       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/logging'</span>)
<span class="hljs-keyword">var</span> plugin_util   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/plugin-util'</span>)
<span class="hljs-keyword">var</span> make_optioner = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/optioner'</span>)
<span class="hljs-keyword">var</span> cmdline       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/cmdline'</span>)
<span class="hljs-keyword">var</span> common        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/common'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create utilities.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> arr = common.arrayify

<span class="hljs-keyword">var</span> error = eraro({
  package:  <span class="hljs-string">'seneca'</span>,
  msgmap:   ERRMSGMAP(),
  override: <span class="hljs-literal">true</span>
})</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Module exports.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = init</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Default options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> DEFAULT_OPTIONS = {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Tag this Seneca instance, will be appended to instance identifier.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  tag:             <span class="hljs-string">'-'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Standard length of identifiers for actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  idlen:           <span class="hljs-number">12</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Standard timeout for actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  timeout:         <span class="hljs-number">11111</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Register (true) default plugins. Set false to not register when
using custom versions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  default_plugins: {
    basic:       <span class="hljs-literal">true</span>,
    <span class="hljs-string">'mem-store'</span>: <span class="hljs-literal">true</span>,
    transport:   <span class="hljs-literal">true</span>,
    web:         <span class="hljs-literal">true</span>,
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Settings for network REPL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  repl:{
    port: <span class="hljs-number">30303</span>,
    host: <span class="hljs-literal">null</span>,
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Debug settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  debug: {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Throw (some) errors from seneca.act.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fragile:    <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Fatal errors … aren’t fatal. Not for production!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    undead:     <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Print debug info to console</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    print: {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Print options. Best used via –seneca.print.options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      options: <span class="hljs-literal">false</span>,
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Trace action caller and place in args.caller$.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    act_caller: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Shorten all identifiers to 2 characters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    short_logs: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Record and log callpoints (calling code locations).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    callpoint:  <span class="hljs-literal">false</span>,
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Enforce strict behaviours. Relax when backwards compatibility needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  strict: {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Action result must be a plain object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    result: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Delegate fixedargs override action args.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fixedargs: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Adding a pattern overrides existing pattern only if matches exactly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    add: <span class="hljs-literal">false</span>,
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Action cache. Makes inbound messages idempotent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  actcache: {
    active: <span class="hljs-literal">true</span>,
    size:   <span class="hljs-number">11111</span>,
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Action executor tracing. See gate-executor module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  trace: {
    act:     <span class="hljs-literal">false</span>,
    stack:   <span class="hljs-literal">false</span>,
    unknown: <span class="hljs-string">'warn'</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Action statistics settings. See rolling-stats module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stats: {
    size:     <span class="hljs-number">1024</span>,
    interval: <span class="hljs-number">60000</span>,
    running:  <span class="hljs-literal">false</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Wait time for plugins to close gracefully.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deathdelay: <span class="hljs-number">11111</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Default seneca-admin settings.
TODO: move to seneca-admin!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  admin: {
    local:  <span class="hljs-literal">false</span>,
    prefix: <span class="hljs-string">'/admin'</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Plugin settings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  plugin: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Internal settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  internal: {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Close instance on these signals, if true.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    close_signals: {
      SIGHUP:   <span class="hljs-literal">true</span>,
      SIGTERM:  <span class="hljs-literal">true</span>,
      SIGINT:   <span class="hljs-literal">true</span>,
      SIGBREAK: <span class="hljs-literal">true</span>,
    },
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Log status at periodic intervals.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  status: {
    interval: <span class="hljs-number">60000</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>By default, does not run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    running:  <span class="hljs-literal">false</span>,
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>zig module settings for seneca.start() chaining.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  zig:{},
}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Create a new Seneca instance.</p>
<ul>
<li>_initial<em>options</em> <code>o</code> &rarr; instance options</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_seneca</span>(<span class="hljs-params"> initial_options </span>) </span>{
  <span class="hljs-comment">/* jshint validthis:true */</span>

  initial_options = initial_options || {} <span class="hljs-comment">// ensure defined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Create a private context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> private$ = make_private()</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Create a new root Seneca instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">new</span> Seneca()</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Define public member variables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.root       = root
  root.start_time = <span class="hljs-built_in">Date</span>.now()
  root.fixedargs  = {}
  root.context    = {}
  root.version    = VERSION</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Seneca methods. Official API.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.add        = api_add        <span class="hljs-comment">// Add a message pattern and action.</span>
  root.act        = api_act        <span class="hljs-comment">// Perform action that matches pattern.</span>
  root.sub        = api_sub        <span class="hljs-comment">// Subscribe to a message pattern.</span>
  root.use        = api_use        <span class="hljs-comment">// Define a plugin.</span>
  root.make       = api_make       <span class="hljs-comment">// Make a new entity object.</span>
  root.listen     = api_listen     <span class="hljs-comment">// Listen for inbound messages.</span>
  root.client     = api_client     <span class="hljs-comment">// Send outbound messages.</span>
  root.export     = api_export     <span class="hljs-comment">// Export plain objects from a plugin.</span>
  root.has        = api_has        <span class="hljs-comment">// True if action pattern defined.</span>
  root.find       = api_find       <span class="hljs-comment">// Find action by pattern</span>
  root.list       = api_list       <span class="hljs-comment">// List (a subset of) action patterns.</span>
  root.ready      = api_ready      <span class="hljs-comment">// Callback when plugins initialized.</span>
  root.close      = api_close      <span class="hljs-comment">// Close and shutdown plugins.</span>
  root.options    = api_options    <span class="hljs-comment">// Get and set options.</span>
  root.repl       = api_repl       <span class="hljs-comment">// Open a REPL on a local port.</span>
  root.start      = api_start      <span class="hljs-comment">// Start an action chain.</span>
  root.error      = api_error      <span class="hljs-comment">// Set global error handler.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Method aliases.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.make$      = api_make
  root.hasact     = api_has</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Non-API methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.logroute   = api_logroute
  root.register   = api_register
  root.depends    = api_depends
  root.cluster    = api_cluster
  root.hasplugin  = api_hasplugin
  root.findplugin = api_findplugin
  root.pin        = api_pin
  root.actroutes  = api_actroutes
  root.act_if     = api_act_if
  root.wrap       = api_wrap
  root.seneca     = api_seneca
  root.fix        = api_fix
  root.delegate   = api_delegate</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Legacy API; Deprecated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.startrepl = api_repl
  root.findact   = api_find</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Create internal tools.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> actnid     = nid({length:<span class="hljs-number">5</span>})
  <span class="hljs-keyword">var</span> refnid     = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">'('</span>+actnid()+<span class="hljs-string">')'</span> }
  <span class="hljs-keyword">var</span> paramcheck = make_paramcheck()
  <span class="hljs-keyword">var</span> argv       = cmdline(root)</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Create option resolver.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  private$.optioner = make_optioner( 
    argv,
    initial_options.module || <span class="hljs-built_in">module</span>.parent || <span class="hljs-built_in">module</span>,
    DEFAULT_OPTIONS )</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Not needed after this point, and screws up debug printing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">delete</span> initial_options.module</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Define options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> so = private$.optioner.set( initial_options )
  paramcheck.options.validate(so,thrower)</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>These need to come from options as required during construction.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  so.internal.actrouter    = so.internal.actrouter    || patrun()
  so.internal.clientrouter = so.internal.clientrouter || patrun(pin_patrun_customizer)
  so.internal.subrouter    = so.internal.subrouter    || patrun(pin_patrun_customizer)</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>DEPRECATED</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.fail = make_legacy_fail( so )


  <span class="hljs-keyword">var</span> callpoint = make_callpoint( so.debug.callpoint )</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Identifier generator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.idgen = nid({length:so.idlen})</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Create a unique identifer for this instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.id = root.idgen()+<span class="hljs-string">'/'</span>+root.start_time+<span class="hljs-string">'/'</span>+process.pid+<span class="hljs-string">'/'</span>+so.tag

  <span class="hljs-keyword">if</span>( so.debug.short_logs || so.log.short ) {
    so.idlen    = <span class="hljs-number">2</span>
    root.idgen  = nid({length:so.idlen})
    root.id     = root.idgen()+<span class="hljs-string">'/'</span>+so.tag
  }

  root.name = <span class="hljs-string">'Seneca/'</span>+root.version+<span class="hljs-string">'/'</span>+root.id

  root.die = makedie( root, {
    type:      <span class="hljs-string">'sys'</span>,
    plugin:    <span class="hljs-string">'seneca'</span>,
    tag:       root.version,
    id:        root.id,
    callpoint: callpoint
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Configure logging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.log = logging.makelog(so.log,{
    id:    root.id,
    start: root.start_time,
    short: !!so.debug.short_logs
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Error events are fatal, unless you’re undead.  These are not the
same as action errors, these are unexpected internal issues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.on(<span class="hljs-string">'error'</span>,root.die)</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>TODO: support options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  private$.executor = executor({
    trace:   _.isFunction(so.trace.act) ? so.trace.act :
      (!!so.trace.act) ? make_trace_act({stack:so.trace.stack}) : <span class="hljs-literal">false</span>,
    timeout: so.timeout,
    error: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span>( !err ) <span class="hljs-keyword">return</span>;
      logging.log_exec_err( root, err )
    },
    msg_codes: {
      timeout:   <span class="hljs-string">'action-timeout'</span>,
      error:     <span class="hljs-string">'action-error'</span>,
      callback:  <span class="hljs-string">'action-callback'</span>,
      execute:   <span class="hljs-string">'action-execute'</span>,
      abandoned: <span class="hljs-string">'action-abandoned'</span>
    }
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>setup status log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; so.status.interval &amp;&amp; so.status.running ) {
    private$.stats = private$.stats || {}
    setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> status = {
        alive: (<span class="hljs-built_in">Date</span>.now()-private$.stats.start),
        act:   private$.stats.act
      }
      root.log.info(<span class="hljs-string">'status'</span>,status)
    },so.status.interval)
  }

  <span class="hljs-keyword">if</span>( so.stats ) {
    private$.timestats = <span class="hljs-keyword">new</span> stats.NamedStats( so.stats.size, so.stats.interval )

    <span class="hljs-keyword">if</span>( so.stats.running ) {
      setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        private$.timestats.calculate()
      }, so.stats.interval )
    }
  }


  private$.plugins      = {}
  private$.exports      = { options: common.deepextend({},so) }
  private$.plugin_order = { byname:[], byref:[] }
  private$.use          = makeuse({
    prefix:    <span class="hljs-string">'seneca-'</span>,
    <span class="hljs-built_in">module</span>:    <span class="hljs-built_in">module</span>,
    msgprefix: <span class="hljs-literal">false</span>,
    builtin:   <span class="hljs-string">''</span>
  })

  private$.actcache = ( so.actcache.active ? 
                        lrucache({max:so.actcache.size}) :
                        {set:_.noop} )

  private$.wait_for_ready = <span class="hljs-literal">false</span>

  private$.actrouter    = so.internal.actrouter
  private$.clientrouter = so.internal.clientrouter
  private$.subrouter    = so.internal.subrouter

  root.on(<span class="hljs-string">'newListener'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">eventname</span>) </span>{
    <span class="hljs-keyword">if</span>( <span class="hljs-string">'ready'</span> == eventname ) {
      <span class="hljs-keyword">if</span>( !private$.wait_for_ready ) {
        private$.wait_for_ready = <span class="hljs-literal">true</span>
        root.act(<span class="hljs-string">'role:seneca,ready:true,gate$:true'</span>)
      }
    }
  })

  root.toString = api_toString


  root.util = {
    deepextend: common.deepextend,
    recurse:    common.recurse,
    clean:      common.clean,
    copydata:   common.copydata,
    nil:        common.nil,
    argprops:   common.argprops,
    print:      common.print,

    router:     <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> patrun() },
    parsecanon: make_entity.parsecanon,
  }


  root.store = {
    init: store.init,
    cmds: store.cmds
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>say hello, printing identifier to log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.log.info( <span class="hljs-string">'hello'</span>, root.toString(), callpoint() )</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>dump options if debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.log.debug(<span class="hljs-string">'options'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> util.inspect(so,<span class="hljs-literal">false</span>,<span class="hljs-literal">null</span>).replace(<span class="hljs-regexp">/[\r\n]/g</span>,<span class="hljs-string">' '</span>)
  })

  <span class="hljs-keyword">if</span>( so.debug.print.options ) {
    console_log(<span class="hljs-string">'\nSeneca Options ('</span>+root.id+<span class="hljs-string">'): before plugins\n'</span>+
                <span class="hljs-string">'===\n'</span>)
    console_log(util.inspect(so,{depth:<span class="hljs-literal">null</span>}))
    console_log(<span class="hljs-string">''</span>)
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_logroute</span>(<span class="hljs-params">entry,handler</span>) </span>{
    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === <span class="hljs-built_in">arguments</span>.length ) <span class="hljs-keyword">return</span> root.log.router.toString()

    entry.handler = handler || entry.handler
    logging.makelogroute(entry,root.log.router)
  }






  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_register</span>(<span class="hljs-params"> plugin </span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    paramcheck.register.validate(plugin,thrower)

    <span class="hljs-keyword">var</span> fullname = plugin.name+(plugin.tag?<span class="hljs-string">'/'</span>+plugin.tag:<span class="hljs-string">''</span>)
    <span class="hljs-keyword">var</span> tag      = plugin.tag||<span class="hljs-string">'-'</span>

    plugin.fullname = fullname

    <span class="hljs-keyword">var</span> sd = plugin_util.make_delegate(
      self,
      plugin,
      {makedie:makedie}
    )

    self.log.debug( <span class="hljs-string">'register'</span>, <span class="hljs-string">'init'</span>, fullname, callpoint() )

    <span class="hljs-keyword">var</span> plugin_options = plugin_util.resolve_options(fullname,plugin,so)

    sd.log.debug(<span class="hljs-string">'DEFINE'</span>,plugin_options)

    <span class="hljs-keyword">var</span> meta
    <span class="hljs-keyword">try</span> {
      meta = plugin_util.define_plugin( sd, plugin, plugin_options )
    }
    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">return</span> sd.die(e)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>legacy api for service function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( _.isFunction(meta) ) {
      meta = {service:meta}
    }

    plugin.name = meta.name || plugin.name
    plugin.tag = 
      meta.tag || 
      plugin.tag ||
      (plugin.options &amp;&amp; plugin.options.tag$)

    plugin.fullname = plugin.name+(plugin.tag?<span class="hljs-string">'/'</span>+plugin.tag:<span class="hljs-string">''</span>)

    plugin.service = meta.service || plugin.service

    sd.__update_plugin__(plugin)

    <span class="hljs-keyword">var</span> pluginref = plugin.name+(plugin.tag?<span class="hljs-string">'/'</span>+plugin.tag:<span class="hljs-string">''</span>)
    private$.plugins[pluginref] = plugin

    private$.plugin_order.byname.push(plugin.name)
    private$.plugin_order.byname = _.uniq(private$.plugin_order.byname)

    private$.plugin_order.byref.push(pluginref)</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>LEGACY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> service = plugin.service
    <span class="hljs-keyword">if</span>( service ) {
      service.log = sd.log
      service.key = pluginref
      self.act(<span class="hljs-string">'role:web'</span>,{use:service})
    }

    self.act(
      {
        init:     plugin.name,
        tag:      plugin.tag,
        <span class="hljs-keyword">default</span>$: {},
        gate$:    <span class="hljs-literal">true</span>,
        fatal$:   <span class="hljs-literal">true</span>,
        local$:   <span class="hljs-literal">true</span>
      },
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,out</span>) </span>{
        <span class="hljs-keyword">if</span>( err ) {
          <span class="hljs-keyword">var</span> plugin_err_code = <span class="hljs-string">'plugin_init'</span>

          plugin.plugin_error = err.message

          <span class="hljs-keyword">if</span>( <span class="hljs-string">'action-timeout'</span> == err.code ) {
            plugin_err_code = <span class="hljs-string">'plugin_init_timeout'</span>
            plugin.timeout = so.timeout
          }

          <span class="hljs-keyword">return</span> self.die(error(err,plugin_err_code,plugin))
        }

        <span class="hljs-keyword">if</span>( so.debug.print &amp;&amp; so.debug.print.options ) {
          console_log(<span class="hljs-string">'\nSeneca Options ('</span>+self.id+<span class="hljs-string">'): plugin: '</span>+plugin.name+
                      (plugin.tag?<span class="hljs-string">'$'</span>+plugin.tag:<span class="hljs-string">''</span>)+<span class="hljs-string">'\n'</span>+
                      <span class="hljs-string">'===\n'</span>)
          console_log(util.inspect(plugin_options,{depth:<span class="hljs-literal">null</span>}))
          console_log(<span class="hljs-string">''</span>)
        }


        <span class="hljs-keyword">return</span> self.log.debug( <span class="hljs-string">'register'</span>, <span class="hljs-string">'ready'</span>, pluginref, out )
      }
    )

    <span class="hljs-keyword">var</span> exports = []

    <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != meta.export ) {
      private$.exports[pluginref] = meta.export
      exports.push(pluginref)
    }

    <span class="hljs-keyword">if</span>( _.isObject(meta.exportmap) || _.isObject(meta.exports) ) {
      meta.exportmap = meta.exportmap || meta.exports
      _.each(meta.exportmap,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,k</span>) </span>{
        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != v ) {
          <span class="hljs-keyword">var</span> exportname = pluginref+<span class="hljs-string">'/'</span>+k
          private$.exports[exportname] = v
          exports.push(exportname)
        }
      })
    }

    self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'install'</span>,pluginref,
                   {exports:exports},fullname!=pluginref?fullname:<span class="hljs-literal">undefined</span>)
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_depends</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> args = norma(<span class="hljs-string">'{pluginname:s deps:a? moredeps:s*}'</span>,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> deps = args.deps || args.moredeps

    _.every(deps, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">depname</span>) </span>{
      <span class="hljs-keyword">if</span>( !_.contains(private$.plugin_order.byname,depname) &amp;&amp;
          !_.contains(private$.plugin_order.byname,<span class="hljs-string">'seneca-'</span>+depname) ) {
        self.die(error(<span class="hljs-string">'plugin_required'</span>,{name:args.pluginname,dependency:depname}))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    })
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_export</span>(<span class="hljs-params"> key </span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Legacy aliases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( <span class="hljs-string">'util'</span> == key ) key = <span class="hljs-string">'basic'</span>;

    <span class="hljs-keyword">var</span> exportval = private$.exports[key];
    <span class="hljs-keyword">if</span>( !exportval ) {
      <span class="hljs-keyword">return</span> self.die(error(<span class="hljs-string">'export_not_found'</span>, {key:key}))
    }

    <span class="hljs-keyword">return</span> exportval;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>all optional</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_make</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)
    args.unshift(self)
    <span class="hljs-keyword">return</span> private$.entity.make$.apply(private$.entity,args)
  }
  root.make$ = root.make




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_listen</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    self.log.info.apply(self,_.flatten([
      <span class="hljs-string">'listen'</span>,<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>],<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">1</span>),callpoint()
    ]))

    <span class="hljs-keyword">var</span> opts   = self.options().transport || {}
    <span class="hljs-keyword">var</span> config = parseConfig( arr(<span class="hljs-built_in">arguments</span>), opts )

    self.act(<span class="hljs-string">'role:transport,cmd:listen'</span>,{config:config,gate$:<span class="hljs-literal">true</span>},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> self.die(error(err,<span class="hljs-string">'transport_listen'</span>,config));
    })

    <span class="hljs-keyword">return</span> self
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_client</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    self.log.info.apply(self,_.flatten([
      <span class="hljs-string">'client'</span>,<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>],<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">1</span>),callpoint()
    ]))

    <span class="hljs-keyword">var</span> opts   = self.options().transport || {}
    <span class="hljs-keyword">var</span> config = parseConfig( arr(<span class="hljs-built_in">arguments</span>), opts )</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Queue messages while waiting for client to become active.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> sendqueue = []
    <span class="hljs-keyword">var</span> sendclient = {
      send: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> args, done </span>) </span>{
        <span class="hljs-keyword">var</span> tosend = {instance:<span class="hljs-keyword">this</span>, args:args, done:done }
        self.log.debug(<span class="hljs-string">'client'</span>,<span class="hljs-string">'sendqueue-add'</span>,sendqueue.length+<span class="hljs-number">1</span>,config,tosend)
        sendqueue.push( tosend )
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>TODO: validate pin, pins args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> pins = config.pins || [config.pin||<span class="hljs-string">''</span>]

    pins = _.map(pins, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pin</span>)</span>{
      <span class="hljs-keyword">return</span> _.isString(pin) ? jsonic(pin) : pin
    })


    _.each(pins,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pin</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Only wrap if pin is specific.
Don’t want to wrap all patterns, esp. system ones!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; _.keys(pin).length ) {
        self.wrap(pin,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args,done</span>)</span>{
          sendclient.send.call( <span class="hljs-keyword">this</span>, args, done )
        })
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>For patterns not locally defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      private$.clientrouter.add(
        pin,
        {
          func: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args,done</span>) </span>{
            sendclient.send.call( <span class="hljs-keyword">this</span>, args, done )
          },
          log:         self.log,
          argpattern:  common.argpattern(pin),
          pattern:     common.argpattern(pin),
          id:          <span class="hljs-string">'CLIENT'</span>,
          client$:     <span class="hljs-literal">true</span>,
          plugin_name:     <span class="hljs-string">'remote$'</span>,
          plugin_fullname: <span class="hljs-string">'remote$'</span>,
        })
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Create client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.act(
      <span class="hljs-string">'role:transport,cmd:client'</span>,
      {config:config,gate$:<span class="hljs-literal">true</span>},
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,liveclient</span>) </span>{
        <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> self.die(error(err,<span class="hljs-string">'transport_client'</span>,config));
        <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == liveclient )
          <span class="hljs-keyword">return</span> self.die(error(<span class="hljs-string">'transport_client_null'</span>,common.clean(config)));</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Process any messages waiting for this client,
before bringing client online.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendnext</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === sendqueue.length ) {
            sendclient = liveclient
            self.log.debug(<span class="hljs-string">'client'</span>,<span class="hljs-string">'sendqueue-clear'</span>,config)
          }
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> tosend = sendqueue.shift()
            self.log.debug(<span class="hljs-string">'client'</span>,<span class="hljs-string">'sendqueue-processing'</span>,
                           sendqueue.length+<span class="hljs-number">1</span>,config,tosend)
            sendclient.send.call(tosend.instance,tosend.args,tosend.done)
            setImmediate(sendnext)
          }
        }
        sendnext()
      })

    <span class="hljs-keyword">return</span> self;
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseConfig</span>(<span class="hljs-params"> args, options </span>) </span>{
    <span class="hljs-keyword">var</span> out = {}

    <span class="hljs-keyword">var</span> config = args.config || args

    <span class="hljs-keyword">if</span>( _.isArray( config ) ) {
      <span class="hljs-keyword">var</span> arglen = config.length

      <span class="hljs-keyword">if</span>( <span class="hljs-number">1</span> === arglen ) {
        <span class="hljs-keyword">if</span>( _.isObject( config[<span class="hljs-number">0</span>] ) ) {
          out = config[<span class="hljs-number">0</span>]
        }
        <span class="hljs-keyword">else</span> {
          out.port = <span class="hljs-built_in">parseInt</span>(config[<span class="hljs-number">0</span>],<span class="hljs-number">10</span>)
        }
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( <span class="hljs-number">2</span> === arglen ) {
        out.port = <span class="hljs-built_in">parseInt</span>(config[<span class="hljs-number">0</span>],<span class="hljs-number">10</span>)
        out.host = config[<span class="hljs-number">1</span>]
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( <span class="hljs-number">3</span> === arglen ) {
        out.port = <span class="hljs-built_in">parseInt</span>(config[<span class="hljs-number">0</span>],<span class="hljs-number">10</span>)
        out.host = config[<span class="hljs-number">1</span>]
        out.path = config[<span class="hljs-number">2</span>]
      }

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>TODO: accept a jsonic string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">else</span> out = config;


    _.each( options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,k</span>)</span>{
      <span class="hljs-keyword">if</span>( _.isObject(v) ) <span class="hljs-keyword">return</span>;
      out[k] =  ( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> === out[k] ? v : out[k] )
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Default transport is web</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    out.type = out.type || <span class="hljs-string">'web'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Aliases.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( <span class="hljs-string">'direct'</span> == out.type || <span class="hljs-string">'http'</span> == out.type ) {
      out.type = <span class="hljs-string">'web'</span>
    }

    <span class="hljs-keyword">var</span> base = options[out.type] || {}

    out = _.extend({},base,out)

    <span class="hljs-keyword">if</span>( <span class="hljs-string">'web'</span> == out.type || <span class="hljs-string">'tcp'</span> == out.type ) {
      out.port = <span class="hljs-literal">null</span> == out.port ? base.port : out.port
      out.host = <span class="hljs-literal">null</span> == out.host ? base.host : out.host
      out.path = <span class="hljs-literal">null</span> == out.path ? base.path : out.path
    }

    <span class="hljs-keyword">return</span> out
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_cluster</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">/* jshint loopfunc:true */</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cluster'</span>)

    <span class="hljs-keyword">if</span>( cluster.isMaster ) {
      <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).cpus().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        cluster.fork()
      })

      cluster.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">worker</span>) </span>{
        cluster.fork()
      })

      <span class="hljs-keyword">var</span> noopinstance = self.delegate()
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> fn <span class="hljs-keyword">in</span> noopinstance ) {
        <span class="hljs-keyword">if</span>( _.isFunction(noopinstance[fn]) ) {
          noopinstance[fn] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> noopinstance; }
        }
      }

      <span class="hljs-keyword">return</span> noopinstance;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self;
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_hasplugin</span>(<span class="hljs-params">plugindesc,tag</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    tag = (<span class="hljs-string">''</span> === tag || <span class="hljs-string">'-'</span> === tag) ? <span class="hljs-literal">null</span> : tag
    <span class="hljs-keyword">return</span> !!self.findplugin(plugindesc,tag)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>get plugin instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_findplugin</span>(<span class="hljs-params">plugindesc,tag</span>) </span>{
    <span class="hljs-keyword">var</span> name = plugindesc.name || plugindesc
    tag = plugindesc.tag || tag

    <span class="hljs-keyword">var</span> key = name+(tag?<span class="hljs-string">'/'</span>+tag:<span class="hljs-string">''</span>)
    <span class="hljs-keyword">var</span> plugin = private$.plugins[key]

    <span class="hljs-keyword">return</span> plugin
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_pin</span>(<span class="hljs-params"> pattern, pinopts </span>) </span>{
    <span class="hljs-keyword">var</span> thispin = <span class="hljs-keyword">this</span>

    pattern = _.isString( pattern ) ? jsonic(pattern) : pattern

    <span class="hljs-keyword">var</span> methodkeys = []
    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> pattern ) {
      <span class="hljs-keyword">if</span>( <span class="hljs-regexp">/[\*\?]/</span>.exec(pattern[key]) ) {
        methodkeys.push(key)
      }
    }


    <span class="hljs-keyword">var</span> methods = private$.actrouter.list(pattern)


    <span class="hljs-keyword">var</span> api = {
      toString: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'pin:'</span>+common.argpattern(pattern)+<span class="hljs-string">'/'</span>+thispin
      }
    }


    methods.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method</span>) </span>{
      <span class="hljs-keyword">var</span> mpat = method.match

      <span class="hljs-keyword">var</span> methodname = <span class="hljs-string">''</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> mkI = <span class="hljs-number">0</span>; mkI &lt; methodkeys.length; mkI++) {
        methodname += ((<span class="hljs-number">0</span>&lt;mkI?<span class="hljs-string">'_'</span>:<span class="hljs-string">''</span>)) + mpat[methodkeys[mkI]]
      }

      api[methodname] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args,cb</span>) </span>{
        <span class="hljs-keyword">var</span> si = <span class="hljs-keyword">this</span> &amp;&amp; <span class="hljs-keyword">this</span>.seneca ? <span class="hljs-keyword">this</span> : thispin

        <span class="hljs-keyword">var</span> fullargs = _.extend({},args,mpat)
        si.act.call(si,fullargs,cb)
      }

      api[methodname].pattern$ = method.match
      api[methodname].name$    = methodname
    })

    <span class="hljs-keyword">if</span>( pinopts ) {
      <span class="hljs-keyword">if</span>( pinopts.include ) {
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; pinopts.include.length; i++ ) {
          <span class="hljs-keyword">var</span> methodname = pinopts.include[i]
          <span class="hljs-keyword">if</span>( thispin[methodname] ) {
            api[methodname] = common.delegate(thispin,thispin[methodname])
          }
        }
      }
    }

    <span class="hljs-keyword">return</span> api
  }


  <span class="hljs-keyword">var</span> pm_custom_args = {
    rules: {
      entity$: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
        <span class="hljs-keyword">var</span> val = ctxt.point
        <span class="hljs-keyword">if</span>( val.entity$ ) {
          <span class="hljs-keyword">if</span>( val.canon$({isa:ctxt.rule.spec}) ) {
            <span class="hljs-keyword">return</span> cb();
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb);
      }
    },
    msgs: {
      entity$: <span class="hljs-string">'The value &lt;%=value%&gt; is not a data entity of kind &lt;%=rule.spec%&gt;'</span>+
        <span class="hljs-string">' (property &lt;%=parentpath%&gt;).'</span>
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_sub</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> subargs = parse_pattern(self,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'action:f actmeta:o?'</span>)
    <span class="hljs-keyword">var</span> pattern = subargs.pattern
    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == pattern.in$ &amp;&amp;
        <span class="hljs-literal">null</span> == pattern.out$ &amp;&amp;
        <span class="hljs-literal">null</span> == pattern.error$ &amp;&amp;
        <span class="hljs-literal">null</span> == pattern.cache$ &amp;&amp;
        <span class="hljs-literal">null</span> == pattern.default$ &amp;&amp;
        <span class="hljs-literal">null</span> == pattern.client$ )
    {
      pattern.in$ = <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">if</span>( !private$.handle_sub ) {
      private$.handle_sub = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args,result</span>) </span>{
        <span class="hljs-keyword">var</span> subfuncs = private$.subrouter.find(args)

        <span class="hljs-keyword">if</span>( subfuncs ) {
          _.each(subfuncs,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">subfunc</span>)</span>{
            <span class="hljs-keyword">try</span> {
              subfunc.call(self,args,result)
            }
            <span class="hljs-keyword">catch</span>(ex) {</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>TODO: not really satisfactory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">var</span> err = error(ex,<span class="hljs-string">'sub_function_catch'</span>,{args:args,result:result})
              self.log.error(
                <span class="hljs-string">'sub'</span>,<span class="hljs-string">'err'</span>,args.meta.id$, err.message, args, error.stack )
            }
          })
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>TODO: other cases</p>

            </div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Subs are triggered via events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.on(<span class="hljs-string">'act-in'</span>,  annotate( <span class="hljs-string">'in$'</span>,  private$.handle_sub))
      self.on(<span class="hljs-string">'act-out'</span>, annotate( <span class="hljs-string">'out$'</span>, private$.handle_sub))
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">annotate</span>(<span class="hljs-params"> prop, handle_sub </span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> args,result </span>) </span>{
        args   = _.clone(args)
        result = _.clone(result)
        args[prop] = <span class="hljs-literal">true</span>
        handle_sub(args,result)
      }
    }

    <span class="hljs-keyword">var</span> subs = private$.subrouter.find(pattern)
    <span class="hljs-keyword">if</span>( !subs ) {
      private$.subrouter.add(pattern,subs=[])
    }
    subs.push(subargs.action)

    <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <h3 id="seneca-add">seneca.add</h3>
<p>Add an message pattern and action function.</p>
<p><code>seneca.add( pattern, action )</code>  </p>
<ul>
<li><em>pattern</em> <code>o|s</code> &rarr; pattern definition</li>
<li><em>action</em> <code>f</code> &rarr; pattern action function</li>
</ul>
<p><code>seneca.add( pattern_string, pattern_object, action )</code>  </p>
<ul>
<li>_pattern<em>string</em> <code>s</code> &rarr; pattern definition as jsonic string</li>
<li>_pattern<em>object</em> <code>o</code> &rarr; pattern definition as object</li>
<li><em>action</em> <code>f</code> &rarr; pattern action function</li>
</ul>
<p>The pattern is defined by the top level properties of the
<em>pattern</em> parameter.  In the case where the pattern is a string,
it is first parsed by
<a href="https://github.com/rjrodger/jsonic">jsonic</a></p>
<p>If the value of a pattern property is a sub-object, this is
interpreted as a
<a href="https://github.com/rjrodger/parambulator">parambulator</a>
validation check. In this case, the property is not considered
part of the pattern, but rather an argument to validate when
<em>seneca.act</em> is called.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_add</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = parse_pattern(self,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'action:f actmeta:o?'</span>)

    <span class="hljs-keyword">var</span> pattern   = args.pattern
    <span class="hljs-keyword">var</span> action    = args.action
    <span class="hljs-keyword">var</span> actmeta   = args.actmeta || {}

    actmeta.plugin_name     = actmeta.plugin_name || <span class="hljs-string">'root$'</span>
    actmeta.plugin_fullname = actmeta.plugin_fullname || 
      actmeta.plugin_name + (actmeta.plugin_tag ? <span class="hljs-string">'/'</span> + actmeta.plugin_tag : <span class="hljs-string">''</span>)

    <span class="hljs-keyword">var</span> add_callpoint = callpoint()
    <span class="hljs-keyword">if</span>( add_callpoint ) {
      actmeta.callpoint = add_callpoint
    }

    actmeta.sub = !!pattern.sub$</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Deprecate a pattern by providing a string message using deprecate$ key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    actmeta.deprecate = pattern.deprecate$

    <span class="hljs-keyword">var</span> strict_add = (pattern.strict$ &amp;&amp; <span class="hljs-literal">null</span> != pattern.strict$.add) ? 
          !!pattern.strict$.add : !!so.strict.add

    pattern = self.util.clean(args.pattern)

    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === _.keys( pattern ) ) {
      <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'add_empty_pattern'</span>,{args:common.clean(args)})
    }

    <span class="hljs-keyword">var</span> pattern_rules = _.clone(action.validate || {})
    _.each( pattern, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,k</span>) </span>{
      <span class="hljs-keyword">if</span>( _.isObject(v) ) {
        pattern_rules[k] = v
        <span class="hljs-keyword">delete</span> pattern[k]
      }
    })

    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; _.keys(pattern_rules).length ) {
      actmeta.parambulator = parambulator(pattern_rules, pm_custom_args)
    }

    <span class="hljs-keyword">var</span> addroute  = <span class="hljs-literal">true</span>

    actmeta.args = _.clone( pattern )
    actmeta.pattern = common.argpattern( pattern )</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>deprecated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    actmeta.argpattern = actmeta.pattern</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>actmeta.id = self.idgen()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    actmeta.id = refnid()

    actmeta.func = action

    <span class="hljs-keyword">var</span> priormeta = self.find( pattern )</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>only exact action patterns are overridden
use .wrap for pin-based patterns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( strict_add &amp;&amp; priormeta &amp;&amp; priormeta.pattern !== actmeta.pattern ) {
      priormeta = <span class="hljs-literal">null</span>
    }


    <span class="hljs-keyword">if</span>( priormeta ) {
      <span class="hljs-keyword">if</span>( _.isFunction(priormeta.handle) ) {
        priormeta.handle(action)
        addroute = <span class="hljs-literal">false</span>
      }
      <span class="hljs-keyword">else</span> {
        actmeta.priormeta = priormeta
      }
      actmeta.priorpath = priormeta.id+<span class="hljs-string">';'</span>+priormeta.priorpath
    }
    <span class="hljs-keyword">else</span> {
      actmeta.priorpath = <span class="hljs-string">''</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>FIX: need a much better way to support layered actions
this “.handle” hack is just to make seneca.close work</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( action &amp;&amp; actmeta &amp;&amp; _.isFunction(action.handle) ) {
      actmeta.handle = action.handle
    }


    private$.stats.actmap[actmeta.argpattern] =
      private$.stats.actmap[actmeta.argpattern] ||
      {id:actmeta.id,
       plugin:{
         full: actmeta.plugin_fullname,
         name: actmeta.plugin_name,
         tag:  actmeta.plugin_tag
       },
       prior:actmeta.priorpath,calls:<span class="hljs-number">0</span>,done:<span class="hljs-number">0</span>,fails:<span class="hljs-number">0</span>,time:{}}

    <span class="hljs-keyword">if</span>( addroute ) {
      <span class="hljs-keyword">var</span> addlog = [ actmeta.sub ? <span class="hljs-string">'SUB'</span> : <span class="hljs-string">'ADD'</span>,
                     actmeta.id, common.argpattern(pattern), action.name,
                     callpoint() ]
      <span class="hljs-keyword">var</span> isplugin = self.context.isplugin
      <span class="hljs-keyword">var</span> logger   = self.log.log || self.log

      <span class="hljs-keyword">if</span>( !isplugin ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>addlog.unshift(‘-‘)
addlog.unshift(‘-‘)
addlog.unshift(‘-‘)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        addlog.unshift(actmeta.plugin_tag)
        addlog.unshift(actmeta.plugin_name)
        addlog.unshift(<span class="hljs-string">'plugin'</span>)
      }

      logger.debug.apply( self, addlog )
      private$.actrouter.add(pattern,actmeta)
    }

    <span class="hljs-keyword">return</span> self
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_find</span>(<span class="hljs-params">args</span>) </span>{
    <span class="hljs-keyword">var</span> local  = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">var</span> remote = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">if</span>( _.isString( args ) ) {
      args = jsonic( args )
    }

    <span class="hljs-keyword">if</span>( _.isBoolean(args.local$) ) {
      local  = args.local$
      remote = !args.local$
    }

    <span class="hljs-keyword">var</span> actmeta = local &amp;&amp; private$.actrouter.find(args)

    <span class="hljs-keyword">if</span>( remote &amp;&amp; !actmeta ) {
      actmeta = private$.clientrouter.find(args)
    }

    <span class="hljs-keyword">return</span> actmeta
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_has</span>(<span class="hljs-params">args</span>) </span>{
    <span class="hljs-keyword">return</span> !!private$.actrouter.find(args)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>TODO: deprecate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.findpins = root.pinact = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> pins = []
    <span class="hljs-keyword">var</span> patterns = _.flatten(arr(<span class="hljs-built_in">arguments</span>))

    _.each( patterns, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pattern</span>) </span>{
      pattern = _.isString(pattern) ? jsonic(pattern) : pattern
      pins = pins.concat( _.map( private$.actrouter.list(pattern),
                                 <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">desc</span>) </span>{<span class="hljs-keyword">return</span> desc.match} ) )
    })

    <span class="hljs-keyword">return</span> pins
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_actroutes</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> private$.actrouter.toString(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>) </span>{
      <span class="hljs-keyword">var</span> s = <span class="hljs-string">'F='</span>

      <span class="hljs-keyword">if</span>( d.plugin_fullname ) {
        s+=d.plugin_fullname+<span class="hljs-string">'/'</span>
      }

      s+=d.id

      <span class="hljs-keyword">while</span>( d.priormeta ) {
        d = d.priormeta
        s+=<span class="hljs-string">';'</span>

        <span class="hljs-keyword">if</span>( d.plugin_fullname ) {
          s+=d.plugin_fullname+<span class="hljs-string">'/'</span>
        }

        s+=d.id

      }
      <span class="hljs-keyword">return</span> s
    })
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_list</span>(<span class="hljs-params"> args </span>) </span>{
    args = _.isString(args) ? jsonic(args) : args

    <span class="hljs-keyword">var</span> found = private$.actrouter.list( args )

    found = _.map( found, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>) </span>{
      <span class="hljs-keyword">return</span> entry.match
    })

    <span class="hljs-keyword">return</span> found
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_act_if</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = norma(<span class="hljs-string">'{execute:b actargs:.*}'</span>,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">if</span>( args.execute ) {
      <span class="hljs-keyword">return</span> self.act.apply( self, args.actargs )
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Perform an action. The properties of the first argument are matched against
known patterns, and the most specific one wins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_act</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> spec    = parse_pattern( self, common.arrayify(<span class="hljs-built_in">arguments</span>), <span class="hljs-string">'done:f?'</span> )
    <span class="hljs-keyword">var</span> args    = spec.pattern
    <span class="hljs-keyword">var</span> actdone = spec.done


    args = _.extend(args,self.fixedargs)
    <span class="hljs-keyword">var</span> actmeta = self.find(args)

    <span class="hljs-keyword">if</span>( so.debug.act_caller ) {
      args.caller$ = <span class="hljs-string">'\n    Action call arguments and location: '</span>+
        (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(util.inspect(args).replace(<span class="hljs-regexp">/\n/g</span>,<span class="hljs-string">''</span>)).stack)
        .replace(<span class="hljs-regexp">/.*\/seneca\.js:.*\n/g</span>,<span class="hljs-string">''</span>)
        .replace(<span class="hljs-regexp">/.*\/seneca\/lib\/.*\.js:.*\n/g</span>,<span class="hljs-string">''</span>)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>action pattern found</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( actmeta ) {
      do_act(self,actmeta,<span class="hljs-literal">false</span>,args,actdone)
      <span class="hljs-keyword">return</span> self;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>action pattern not found</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span>( _.isPlainObject( args.default$ ) ) {
      self.log.debug(<span class="hljs-string">'act'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'DEFAULT'</span>,self.util.clean(args),callpoint())
      <span class="hljs-keyword">if</span>( actdone ) actdone.call( self, <span class="hljs-literal">null</span>, _.clone(args.default$) );
      <span class="hljs-keyword">return</span> self;
    }

    <span class="hljs-keyword">var</span> errcode = <span class="hljs-string">'act_not_found'</span>
    <span class="hljs-keyword">var</span> errinfo = { args: util.inspect(common.clean(args)).replace(<span class="hljs-regexp">/\n/g</span>,<span class="hljs-string">''</span>) }

    <span class="hljs-keyword">if</span>( !_.isUndefined( args.default$ ) ) {
      errcode = <span class="hljs-string">'act_default_bad'</span>
      errinfo.xdefault = util.inspect(args.default$)
    }

    <span class="hljs-keyword">var</span> err = error( errcode, errinfo )

    <span class="hljs-keyword">if</span>( args.fatal$ ) {
      self.die(err)
      <span class="hljs-keyword">return</span> self;
    }

    logging.log_act_bad( root, err, so.trace.unknown )

    <span class="hljs-keyword">if</span>( so.debug.fragile ) <span class="hljs-keyword">throw</span> err;

    <span class="hljs-keyword">if</span>( actdone ) actdone.call( self, err );
    <span class="hljs-keyword">return</span> self;
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_wrap</span>(<span class="hljs-params">pin,wrapper</span>) </span>{
    <span class="hljs-keyword">var</span> pinthis = <span class="hljs-keyword">this</span>

    pin = _.isArray(pin) ? pin : [pin]
    _.each(pin, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>) </span>{
      _.each( pinthis.findpins(p), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">actpattern</span>) </span>{
        pinthis.add(actpattern,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args,done</span>) </span>{
          wrapper.call(<span class="hljs-keyword">this</span>,args,done)
        })
      })
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>close seneca instance
sets public seneca.closed property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_close</span>(<span class="hljs-params">done</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    self.closed = <span class="hljs-literal">true</span>

    self.log.debug( <span class="hljs-string">'close'</span>, <span class="hljs-string">'start'</span>, callpoint() )
    self.act(<span class="hljs-string">'role:seneca,cmd:close,closing$:true'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      self.log.debug(<span class="hljs-string">'close'</span>,<span class="hljs-string">'end'</span>,err)
      <span class="hljs-keyword">if</span>( _.isFunction(done) ) <span class="hljs-keyword">return</span> done.call(self,err);
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>useful when defining services!
note: has EventEmitter.once semantics
if using .on(‘ready’,fn) it will be be called for each ready event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_ready</span>(<span class="hljs-params">ready</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">if</span>( so.debug.callpoint ) {
      self.log.debug( <span class="hljs-string">'ready'</span>, <span class="hljs-string">'register'</span>, callpoint() )
    }

    <span class="hljs-keyword">if</span>( _.isFunction(ready) ) {
      self.once(<span class="hljs-string">'ready'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">var</span> ready_delegate = self.delegate({fatal$:<span class="hljs-literal">true</span>})
          ready.call(ready_delegate)
        }
        <span class="hljs-keyword">catch</span>(ex) {
          <span class="hljs-keyword">var</span> re = ex

          <span class="hljs-keyword">if</span>( !re.seneca ) {
            re = error(re,<span class="hljs-string">'ready_failed'</span>, {message:ex.message,ready:ready})
          }

          self.die( re )
        }
      })

      <span class="hljs-keyword">if</span>( !private$.wait_for_ready ) {
        private$.wait_for_ready = <span class="hljs-literal">true</span>
        self.act(<span class="hljs-string">'role:seneca,ready:true,gate$:true'</span>)
      }
    }

    <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>use(‘pluginname’) - built-in, or provide calling code ‘require’ as seneca opt
use( require(‘pluginname’) ) - plugin object, init will be called
if first arg has property senecaplugin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_use</span>(<span class="hljs-params"> arg0, arg1, arg2 </span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>, plugindesc;</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Allow chaining with seneca.use(‘options’, {…})
see <a href="https://github.com/rjrodger/seneca/issues/80">https://github.com/rjrodger/seneca/issues/80</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( <span class="hljs-string">'options'</span> == arg0 ) {
      self.options( arg1 )
      <span class="hljs-keyword">return</span> self
    }

    <span class="hljs-keyword">try</span> {
      plugindesc = private$.use( arg0, arg1, arg2 )
    }
    <span class="hljs-keyword">catch</span>(e) {
      self.die( error(e,<span class="hljs-string">'plugin_'</span>+e.code) );
      <span class="hljs-keyword">return</span> self;
    }

    self.register( plugindesc )

    <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>TODO: move repl functionality to seneca-repl</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  root.inrepl = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    self.on(<span class="hljs-string">'act-out'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      logging.handlers.print.apply(<span class="hljs-literal">null</span>,arr(<span class="hljs-built_in">arguments</span>))
    })

    self.on(<span class="hljs-string">'error'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>).slice()
      args.unshift(<span class="hljs-string">'ERROR: '</span>)
      logging.handlers.print.apply(<span class="hljs-literal">null</span>,arr(args))
    })
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_repl</span>(<span class="hljs-params">in_opts</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> repl_opts = _.extend(so.repl,in_opts)

    net.createServer( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket</span>) </span>{
      <span class="hljs-keyword">var</span> actout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> out = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] || <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]
        socket.write(util.inspect(out)+<span class="hljs-string">'\n'</span>)
      }

      <span class="hljs-keyword">var</span> r = repl.start({
        prompt:    <span class="hljs-string">'seneca '</span>+root.id+<span class="hljs-string">'&gt; '</span>,
        input:     socket,
        output:    socket,
        terminal:  <span class="hljs-literal">false</span>,
        useGlobal: <span class="hljs-literal">false</span>,
        <span class="hljs-built_in">eval</span>:      evaluate
      })

      r.on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        socket.end()
      })

      <span class="hljs-keyword">var</span> act_index_map = {}
      <span class="hljs-keyword">var</span> act_index = <span class="hljs-number">1000000</span>
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fmt_index</span>(<span class="hljs-params">i</span>) </span>{
        <span class="hljs-keyword">return</span> (<span class="hljs-string">''</span>+i).substring(<span class="hljs-number">1</span>)
      }

      <span class="hljs-keyword">var</span> sd = root.delegate({repl$:<span class="hljs-literal">true</span>})

      sd.on_act_in = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">on_act_in</span>(<span class="hljs-params"> actmeta, args </span>) </span>{
        socket.write(<span class="hljs-string">'IN  '</span>+fmt_index(act_index)+
                     <span class="hljs-string">': '</span>+util.inspect(sd.util.clean(args))+
                     <span class="hljs-string">' # '</span>+
                     args.meta$.id+<span class="hljs-string">' '</span>+
                     actmeta.pattern+<span class="hljs-string">' '</span>+
                     actmeta.id+<span class="hljs-string">' '</span>+
                     actmeta.func.name+<span class="hljs-string">' '</span>+
                     (actmeta.callpoint?actmeta.callpoint:<span class="hljs-string">''</span>)+
                     <span class="hljs-string">'\n'</span>)
        act_index_map[actmeta.id] = act_index
        act_index++
      }

      sd.on_act_out = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">on_act_out</span>(<span class="hljs-params"> actmeta, out </span>) </span>{
        <span class="hljs-keyword">var</span> cur_index = act_index_map[actmeta.id]
        socket.write(<span class="hljs-string">'OUT '</span>+fmt_index(cur_index)+
                     <span class="hljs-string">': '</span>+util.inspect(sd.util.clean(out))+<span class="hljs-string">'\n'</span>)
      }

      sd.on_act_err = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">on_act_err</span>(<span class="hljs-params"> actmeta, err </span>) </span>{
        <span class="hljs-keyword">var</span> cur_index = act_index_map[actmeta.id]
        socket.write(<span class="hljs-string">'ERR '</span>+fmt_index(cur_index)+
                     <span class="hljs-string">': '</span>+err.message+<span class="hljs-string">'\n'</span>)
      }

        <span class="hljs-comment">/*
      sd.act = function act() {

        var spec = parse_pattern( self, common.arrayify(arguments), 'done:f?' )
        var args = spec.pattern
        var done = spec.done

        socket.write('IN  '+fmt_index(act_index)+
                     ': '+util.inspect(sd.util.clean(args))+'\n')
        var out_index = act_index
        act_index++


        self.act.call(this,args,function(err,out){
          if( err ) {
            socket.write('ERR '+fmt_index(act_index)+': '+err.message+'\n')
          }
          else {
            socket.write('OUT '+fmt_index(out_index)+
                         ': '+util.inspect(sd.util.clean(out))+'\n')
          }

          done(err,out)
        })
      }
         */</span>

      r.context.s = r.context.seneca = sd


      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">evaluate</span>(<span class="hljs-params">cmd, context, filename, callback</span>) </span>{
        <span class="hljs-keyword">var</span> result

        cmd = cmd.replace(<span class="hljs-regexp">/[\r\n]+$/</span>,<span class="hljs-string">''</span>)

        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">var</span> args = jsonic(cmd)
          context.s.act(args,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,out</span>)</span>{
            <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> callback( err.message );
            <span class="hljs-keyword">return</span> callback( <span class="hljs-literal">null</span>, root.util.clean(out) );
          })
        }
        <span class="hljs-keyword">catch</span>( e ) {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> script = vm.createScript(cmd, {
              filename: filename,
              displayErrors: <span class="hljs-literal">false</span>
            })
            result = script.runInContext(context, { displayErrors: <span class="hljs-literal">false</span> });

            result = result === root ? <span class="hljs-literal">null</span> : result
            callback(<span class="hljs-literal">null</span>, result)
          }
          <span class="hljs-keyword">catch</span>( e ) {
            <span class="hljs-keyword">return</span> callback( e.message )
          }
        }
      }

    }).listen( repl_opts.port, repl_opts.host )
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Return self. Mostly useful as a check that this is a Seneca instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_seneca</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Describe this instance using the form: Seneca/VERSION/ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_toString</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_act</span>(<span class="hljs-params"> instance, actmeta, prior_ctxt, origargs, cb </span>) </span>{
    <span class="hljs-keyword">var</span> args = _.clone(origargs)
    prior_ctxt = prior_ctxt || {chain:[],entry:<span class="hljs-literal">true</span>,depth:<span class="hljs-number">1</span>}

    <span class="hljs-keyword">var</span> act_callpoint = callpoint()

    <span class="hljs-keyword">var</span> id_tx = ( args.id$ || args.actid$ || instance.idgen() ).split(<span class="hljs-string">'/'</span>)

    <span class="hljs-keyword">var</span> tx = 
          id_tx[<span class="hljs-number">1</span>] ||
          origargs.tx$ ||
          instance.fixedargs.tx$ ||
          instance.idgen()

    <span class="hljs-keyword">var</span> actid    = (id_tx[<span class="hljs-number">0</span>] || instance.idgen()) + <span class="hljs-string">'/'</span> + tx 

    <span class="hljs-keyword">var</span> actstart = <span class="hljs-built_in">Date</span>.now()

    cb = cb || common.noop

    <span class="hljs-keyword">if</span>( act_cache_check( instance, args, prior_ctxt, cb, act_callpoint ) ) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> actstats = act_stats_call( actmeta.pattern )</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>build callargs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> callargs = args</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>remove actid so that user manipulation of args for subsequent use does
not cause inadvertent hit on existing action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">delete</span> callargs.id$
    <span class="hljs-keyword">delete</span> callargs.actid$ <span class="hljs-comment">// legacy alias</span>

    callargs.meta$ = {
      id:      actid,
      tx:      tx,
      start:   actstart,
      pattern: actmeta.pattern,
      action:  actmeta.id,
      entry:   prior_ctxt.entry,
      chain:   prior_ctxt.chain
    }

    <span class="hljs-keyword">if</span>( actmeta.deprecate ) {
      instance.log.warn( <span class="hljs-string">'DEPRECATED'</span>, actmeta.pattern, actmeta.deprecate,
                         act_callpoint )
    }

    logging.log_act_in( root, {actid:actid,info:origargs.transport$}, 
                        actmeta, callargs, prior_ctxt,
                        act_callpoint )

    instance.emit(<span class="hljs-string">'act-in'</span>, callargs)

    <span class="hljs-keyword">var</span> delegate = act_make_delegate( instance, tx, callargs, actmeta, prior_ctxt )

    callargs = _.extend({},callargs,delegate.fixedargs,{tx$:tx})

    <span class="hljs-keyword">var</span> listen_origin = origargs.transport$ &amp;&amp; origargs.transport$.origin

    <span class="hljs-keyword">var</span> act_done = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> actend = <span class="hljs-built_in">Date</span>.now()
        private$.timestats.point( actend-actstart, actmeta.argpattern )

        prior_ctxt.depth--
        prior_ctxt.entry = prior_ctxt.depth &lt;= <span class="hljs-number">0</span>

        <span class="hljs-keyword">var</span> result  = arr(<span class="hljs-built_in">arguments</span>)
        <span class="hljs-keyword">var</span> call_cb = <span class="hljs-literal">true</span>

        <span class="hljs-keyword">var</span> resdata = result[<span class="hljs-number">1</span>]
        <span class="hljs-keyword">var</span> info    = result[<span class="hljs-number">2</span>]

        <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == err &amp;&amp;
            <span class="hljs-literal">null</span> != resdata &amp;&amp;
            !(_.isPlainObject(resdata) ||
              _.isArray(resdata) ||
              !!resdata.entity$ ||
              !!resdata.force$
             ) &amp;&amp;
            so.strict.result)
        {</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>allow legacy patterns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>( !( <span class="hljs-string">'generate_id'</span> === callargs.cmd ||
                 <span class="hljs-literal">true</span> === callargs.note ||
                 <span class="hljs-string">'native'</span> === callargs.cmd ||
                 <span class="hljs-string">'quickcode'</span> === callargs.cmd 
               ))
          {
            err = error(
              <span class="hljs-string">'result_not_objarr'</span>, {
                pattern:actmeta.pattern,
                args:util.inspect(common.clean(callargs)).replace(<span class="hljs-regexp">/\n/g</span>,<span class="hljs-string">''</span>),
                result:resdata
              })
          }
        }

        private$.actcache.set(actid,{
          result:  result,
          actmeta: actmeta,
          when:    <span class="hljs-built_in">Date</span>.now()
        })

        <span class="hljs-keyword">if</span>( err ) {
          private$.stats.act.fails++
          actstats.fails++

          <span class="hljs-keyword">var</span> out = act_error(instance,err,actmeta,result,cb,
                              actend-actstart,callargs,prior_ctxt,act_callpoint)

          call_cb = out.call_cb
          result[<span class="hljs-number">0</span>] = out.err

          <span class="hljs-keyword">if</span>( _.isFunction(delegate.on_act_err) ) {
            delegate.on_act_err(actmeta,result[<span class="hljs-number">0</span>])
          }

          <span class="hljs-keyword">if</span>( args.fatal$ ) {
            <span class="hljs-keyword">return</span> instance.die(out.err);
          }
        }
        <span class="hljs-keyword">else</span> {
          instance.emit(<span class="hljs-string">'act-out'</span>,callargs,result[<span class="hljs-number">1</span>])
          result[<span class="hljs-number">0</span>] = <span class="hljs-literal">null</span>

          logging.log_act_out(
            root, {
              actid:    actid,
              duration: actend-actstart,
              info:     info,
              listen:   listen_origin
            },
            actmeta, callargs, result, prior_ctxt, act_callpoint )

          <span class="hljs-keyword">if</span>( _.isFunction(delegate.on_act_out) ) {
            delegate.on_act_out(actmeta,result[<span class="hljs-number">1</span>])
          }

          private$.stats.act.done++
          actstats.done++
        }

        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span>( call_cb ) {
            cb.apply(delegate,result.slice(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)) <span class="hljs-comment">// note: err == result[0]</span>
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>for exceptions thrown inside the callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">catch</span>( ex ) {
          <span class="hljs-keyword">var</span> err = ex</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>handle throws of non-Error values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>( !util.isError(ex) ) {
            err = ( _.isObject(ex) ?
                    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(jsonic.stringify(ex)) :
                    err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">''</span>+ex) )
          }

          callback_error( instance, err, actmeta, result, cb,
                          actend-actstart, callargs, prior_ctxt, act_callpoint )
        }
      }
      <span class="hljs-keyword">catch</span>(ex) {
        instance.emit(<span class="hljs-string">'error'</span>,ex)
      }
    }



    act_param_check( origargs, actmeta, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> err </span>) </span>{
      <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> act_done(err);

      <span class="hljs-keyword">var</span> execspec = {
        id:      actid,
        gate:    prior_ctxt.entry &amp;&amp; !!callargs.gate$,
        ungate:  !!callargs.ungate$,
        desc:    actmeta.argpattern,
        cb:      act_done,

        plugin: {
          name: actmeta.plugin_name,
          tag:  actmeta.plugin_tag
        },

        fn:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
          <span class="hljs-keyword">if</span>( root.closed &amp;&amp; !callargs.closing$ ) {
            <span class="hljs-keyword">return</span> cb(error(<span class="hljs-string">'instance-closed'</span>,{args:common.clean(callargs)}))
          }

          delegate.good = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">out</span>) </span>{
            cb(<span class="hljs-literal">null</span>,out)
          }

          delegate.bad = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
            cb(err)
          }

          <span class="hljs-keyword">if</span>( _.isFunction(delegate.on_act_in) ) {
            delegate.on_act_in(actmeta,callargs)
          }
          actmeta.func.call(delegate,callargs,cb)
        },
      }

      private$.executor.execute(execspec)
    })
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_error</span>(<span class="hljs-params"> instance, err, actmeta, result, cb,
                      duration, callargs, prior_ctxt, act_callpoint </span>)
  </span>{
    <span class="hljs-keyword">var</span> call_cb = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">if</span>( !err.seneca ) {
      err = error(err,<span class="hljs-string">'act_execute'</span>,_.extend(
        {},
        err.details,
        {
          message:  (err.eraro &amp;&amp; err.orig) ? err.orig.message : err.message,
          pattern:  actmeta.pattern,
          fn:       actmeta.func,
          cb:       cb,
          instance: instance.toString()
        }))

      result[<span class="hljs-number">0</span>] = err
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Special legacy case for seneca-perm</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( err.orig &amp;&amp; 
             _.isString(err.orig.code) &amp;&amp; 
             <span class="hljs-number">0</span> === err.orig.code.indexOf(<span class="hljs-string">'perm/'</span>) ) 
    {
      err = err.orig
      result[<span class="hljs-number">0</span>] = err
    }

    err.details = err.details || {}
    err.details.plugin = err.details.plugin || {}

    logging.log_act_err( root, {
      actid:    callargs.id$ || callargs.actid$,
      duration: duration
    }, actmeta, callargs, prior_ctxt, err, act_callpoint )

    instance.emit(<span class="hljs-string">'act-err'</span>,callargs,err)

    <span class="hljs-keyword">if</span>( so.errhandler ) {
      call_cb = !so.errhandler.call(instance,err)
    }

    <span class="hljs-keyword">return</span> {call_cb:call_cb,err:err}
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callback_error</span>(<span class="hljs-params"> instance, err, actmeta, result, cb,
                           duration, callargs, prior_ctxt, act_callpoint </span>)
  </span>{
    <span class="hljs-keyword">if</span>( !err.seneca ) {
      err = error(err,<span class="hljs-string">'act_callback'</span>,_.extend(
        {},
        err.details,
        {
          message:  err.message,
          pattern:  actmeta.pattern,
          fn:       actmeta.func,
          cb:       cb,
          instance: instance.toString()
        }))

      result[<span class="hljs-number">0</span>] = err
    }

    err.details = err.details || {}
    err.details.plugin = err.details.plugin || {}

    logging.log_act_err( root, {
      actid:    callargs.id$ || callargs.actid$,
      duration: duration
    }, actmeta, callargs, prior_ctxt, err, act_callpoint )

    instance.emit(<span class="hljs-string">'act-err'</span>,callargs,err,result[<span class="hljs-number">1</span>])

    <span class="hljs-keyword">if</span>( so.errhandler ) {
      so.errhandler.call(instance,err)
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Check if actid has already been seen, and if action cache is active,
then provide cached result, if any. Return true in this case.</p>
<ul>
<li><em>instance</em>      (object)    &rarr;  seneca instance</li>
<li><em>args</em>          (object)    &rarr;  action arguments</li>
<li>_prior<em>ctxt</em>    (object?)   &rarr;  prior action context, if any</li>
<li><em>actcb</em>         (function)  &rarr;  action callback</li>
<li>_act<em>callpoint</em> (function)  &rarr;  action call point</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_cache_check</span>(<span class="hljs-params"> instance, args, prior_ctxt, actcb, act_callpoint </span>) </span>{
    assert.ok( _.isObject(instance), <span class="hljs-string">'act_cache_check; instance; isObject'</span>)
    assert.ok( _.isObject(args),     <span class="hljs-string">'act_cache_check; args; isObject'</span>)
    assert.ok( !prior_ctxt || _.isObject(prior_ctxt),
               <span class="hljs-string">'act_cache_check; prior_ctxt; isObject'</span>)
    assert.ok( !actcb || _.isFunction(actcb),
               <span class="hljs-string">'act_cache_check; actcb; isFunction'</span>)

    <span class="hljs-keyword">var</span> actid = args.id$ || args.actid$

    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> != actid &amp;&amp; so.actcache.active ) {
      <span class="hljs-keyword">var</span> actdetails = private$.actcache.get(actid)

      <span class="hljs-keyword">if</span>( actdetails ) {
        <span class="hljs-keyword">var</span> actmeta = actdetails.actmeta || {}
        private$.stats.act.cache++

        logging.log_act_cache( root, {actid:actid}, actmeta,
                               args, prior_ctxt, act_callpoint )

        <span class="hljs-keyword">if</span>( actcb ) actcb.apply( instance, actdetails.result );
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Resolve action stats object, creating if ncessary, and count a call.</p>
<ul>
<li><em>pattern</em>     (string)    &rarr;  action pattern</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_stats_call</span>(<span class="hljs-params"> pattern </span>) </span>{
    <span class="hljs-keyword">var</span> actstats = (private$.stats.actmap[pattern] =
                    private$.stats.actmap[pattern] || {})

    private$.stats.act.calls++
    actstats.calls++

    <span class="hljs-keyword">return</span> actstats
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_make_delegate</span>(<span class="hljs-params"> instance, tx, callargs, actmeta, prior_ctxt </span>) </span>{
    <span class="hljs-keyword">var</span> delegate_args = {}
    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> != callargs.gate$ ) {
      delegate_args.ungate$ = !!callargs.gate$
    }

    <span class="hljs-keyword">var</span> delegate = instance.delegate( delegate_args )</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>special overrides</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( tx ) { delegate.fixedargs.tx$ = tx }</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>automate actid log insertion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    delegate.log = logging.make_delegate_log( callargs.meta$.id, actmeta, instance )
    logging.makelogfuncs(delegate)

    <span class="hljs-keyword">if</span>( actmeta.priormeta ) {
      delegate.prior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prior_args,prior_cb</span>) </span>{
        prior_args = _.clone(prior_args)

        <span class="hljs-keyword">var</span> sub_prior_ctxt = _.clone(prior_ctxt)
        sub_prior_ctxt.chain = _.clone(prior_ctxt.chain)
        sub_prior_ctxt.chain.push( actmeta.id )
        sub_prior_ctxt.entry = <span class="hljs-literal">false</span>
        sub_prior_ctxt.depth++;

        <span class="hljs-keyword">delete</span> prior_args.id$
        <span class="hljs-keyword">delete</span> prior_args.actid$
        <span class="hljs-keyword">delete</span> prior_args.meta$
        <span class="hljs-keyword">delete</span> prior_args.transport$

        <span class="hljs-keyword">if</span>( callargs.default$ ) {
          prior_args.default$ = callargs.default$
        }

        prior_args.tx$ = tx

        do_act(delegate,actmeta.priormeta,sub_prior_ctxt,prior_args,prior_cb)
      }

      delegate.parent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prior_args,prior_cb</span>) </span>{
        delegate.log.warn(<span class="hljs-string">'The method name seneca.parent is deprecated.'</span>+
                          <span class="hljs-string">' Please use seneca.prior instead.'</span>)
        delegate.prior(prior_args,prior_cb)
      }
    }
    <span class="hljs-keyword">else</span> delegate.prior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> msg, done </span>) </span>{
      <span class="hljs-keyword">var</span> out = callargs.default$ ? callargs.default$ : <span class="hljs-literal">null</span>
      <span class="hljs-keyword">return</span> done.call( delegate, <span class="hljs-literal">null</span>, out )
    }

    <span class="hljs-keyword">return</span> delegate;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Check if action parameters pass parambulator spec, if any.</p>
<ul>
<li><em>args</em>     (object)    &rarr;  action arguments</li>
<li><em>actmeta</em>  (object)    &rarr;  action meta data</li>
<li><em>done</em>     (function)  &rarr;  callback function</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">act_param_check</span>(<span class="hljs-params"> args, actmeta, done </span>) </span>{
    assert.ok( _.isObject(args),    <span class="hljs-string">'act_param_check; args; isObject'</span>)
    assert.ok( _.isObject(actmeta), <span class="hljs-string">'act_param_check; actmeta; isObject'</span>)
    assert.ok( _.isFunction(done),  <span class="hljs-string">'act_param_check; done; isFunction'</span>)

    <span class="hljs-keyword">if</span>( actmeta.parambulator ) {
      actmeta.parambulator.validate(args,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> done(
          error(<span class="hljs-string">'act_invalid_args'</span>, {
            pattern: actmeta.pattern,
            message: err.message,
            args:    common.clean(args)
          }));
        <span class="hljs-keyword">return</span> done();
      })
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> done();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>string args override object args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_pattern</span>(<span class="hljs-params">instance,args,normaspec,fixed</span>) </span>{
    args = norma(<span class="hljs-string">'{strargs:s? objargs:o? moreobjargs:o? '</span>+(normaspec||<span class="hljs-string">''</span>)+<span class="hljs-string">'}'</span>, args)

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> _.extend(
        args,
        { pattern: _.extend(
          {},</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Precedence of arguments in add,act is left-to-right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          args.moreobjargs ? args.moreobjargs : {},
          args.objargs ? args.objargs : {},
          args.strargs ? jsonic( args.strargs ) : {},

          fixed || {} )
        })
    }
    <span class="hljs-keyword">catch</span>( e ) {
      <span class="hljs-keyword">var</span> col = <span class="hljs-number">1</span>==e.line?e.column-<span class="hljs-number">1</span>:e.column
      <span class="hljs-keyword">throw</span> error(<span class="hljs-string">'add_string_pattern_syntax'</span>,{
        argstr: args,
        syntax: e.message,
        line:   e.line,
        col:    col
      })
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_fix</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> defargs = parse_pattern(self,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> fix = self.delegate( defargs.pattern )

    fix.add = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> args    = parse_pattern(fix,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'rest:.*'</span>,defargs.pattern)
      <span class="hljs-keyword">var</span> addargs = [args.pattern].concat(args.rest)
      <span class="hljs-keyword">return</span> self.add.apply(fix,addargs)
    }

    <span class="hljs-keyword">return</span> fix
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_delegate</span>(<span class="hljs-params">fixedargs</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> delegate = <span class="hljs-built_in">Object</span>.create(self)
    <span class="hljs-keyword">var</span> act = self.act

    delegate.did = refnid()


      <span class="hljs-comment">/*
    delegate.act = function() {

      var spec = parse_pattern( self, common.arrayify(arguments), 'done:f?' )
      var args = spec.pattern
      var cb   = spec.done

      args = ( so.strict.fixedargs ?
               _.extend({},args,fixedargs) :
               _.extend({},fixedargs,args) )


      act.call(this,args,cb)

      return delegate
    }
       */</span>

    <span class="hljs-keyword">var</span> strdesc
    delegate.toString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span>( strdesc ) <span class="hljs-keyword">return</span> strdesc;
      <span class="hljs-keyword">var</span> vfa = {}
      _.each(fixedargs,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,k</span>) </span>{
        <span class="hljs-keyword">if</span>( ~k.indexOf(<span class="hljs-string">'$'</span>) ) <span class="hljs-keyword">return</span>;
        vfa[k]=v
      })

      strdesc = self.toString()+
        (_.keys(vfa).length?<span class="hljs-string">'/'</span>+jsonic.stringify(vfa):<span class="hljs-string">''</span>)

      <span class="hljs-keyword">return</span> strdesc
    }

    delegate.fixedargs = ( so.strict.fixedargs ?
                           _.extend({},fixedargs,self.fixedargs) :
                           _.extend({},self.fixedargs,fixedargs) )

    delegate.delegate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">further_fixedargs</span>) </span>{
      <span class="hljs-keyword">var</span> args = _.extend({},delegate.fixedargs,further_fixedargs||{})
      <span class="hljs-keyword">return</span> self.delegate.call(<span class="hljs-keyword">this</span>,args)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Somewhere to put contextual data for this delegate.
For example, data for individual web requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    delegate.context = {}

    delegate.client = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> self.client.call(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>)
    }

    delegate.listen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> self.listen.call(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>)
    }

    <span class="hljs-keyword">return</span> delegate
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_options</span>(<span class="hljs-params"> options </span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> != options ) {
      self.log.debug( <span class="hljs-string">'options'</span>, <span class="hljs-string">'set'</span>, options, callpoint() )
    }

    so = private$.exports.options =( (<span class="hljs-literal">null</span> == options) ? 
                                     private$.optioner.get() : 
                                     private$.optioner.set( options ) )

    <span class="hljs-keyword">if</span>( options &amp;&amp; options.log ) {
      self.log = logging.makelog(so.log,self.id,self.start_time)
    }

    <span class="hljs-keyword">return</span> so
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_start</span>(<span class="hljs-params"> errhandler </span>) </span>{
    <span class="hljs-keyword">var</span> sd = <span class="hljs-keyword">this</span>.delegate()
    <span class="hljs-keyword">var</span> options = sd.options()
    options.zig = options.zig || {}


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_fn</span>(<span class="hljs-params">self,origargs</span>) </span>{
      <span class="hljs-keyword">var</span> args = parse_pattern(self,origargs,<span class="hljs-string">'fn:f?'</span>)

      <span class="hljs-keyword">var</span> actargs = _.extend(
        {},
        args.moreobjargs ? args.moreobjargs : {},
        args.objargs ? args.objargs : {},
        args.strargs ? jsonic( args.strargs ) : {}
      )

      <span class="hljs-keyword">var</span> fn
      <span class="hljs-keyword">if</span>( args.fn ) {
        fn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data,done</span>)</span>{
          <span class="hljs-keyword">return</span> args.fn.call(self,data,done)
        }
      }
      <span class="hljs-keyword">else</span> {
        fn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data,done</span>)</span>{
          <span class="hljs-comment">/* jshint evil:true */</span>

          <span class="hljs-keyword">if</span>( args.strargs ) {
            <span class="hljs-keyword">var</span> $ = data
            _.each(actargs,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,k</span>)</span>{
              <span class="hljs-keyword">if</span>( _.isString(v) &amp;&amp; <span class="hljs-number">0</span>===v.indexOf(<span class="hljs-string">'$.'</span>) ) {
                actargs[k] = <span class="hljs-built_in">eval</span>(v)
              }
            })
          }

          self.act(actargs,done)
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        }
        fn.nm = args.strargs
      }

      <span class="hljs-keyword">return</span> fn
    }


    <span class="hljs-keyword">var</span> dzig = zig({
      timeout: options.zig.timeout || options.timeout,
      trace: options.zig.trace
    })

    dzig.start(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
      dzig.end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span>( errhandler ) errhandler.apply(self,<span class="hljs-built_in">arguments</span>);
      })
    })

    sd.end = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>)</span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
      dzig.end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span>( cb ) <span class="hljs-keyword">return</span> cb.apply(self,<span class="hljs-built_in">arguments</span>);
        <span class="hljs-keyword">if</span>( errhandler ) <span class="hljs-keyword">return</span> errhandler.apply(self,<span class="hljs-built_in">arguments</span>);
      })
      <span class="hljs-keyword">return</span> self
    }

    sd.wait = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      dzig.wait(make_fn(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.step = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      dzig.step(make_fn(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.run = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      dzig.run(make_fn(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.if = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cond</span>)</span>{
      dzig.if(cond)
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.endif = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      dzig.endif()
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    sd.fire = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      dzig.step(make_fn(<span class="hljs-keyword">this</span>,<span class="hljs-built_in">arguments</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    <span class="hljs-keyword">return</span> sd
  }


  
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_error</span>(<span class="hljs-params"> errhandler </span>) </span>{
    <span class="hljs-keyword">this</span>.options( {errhandler:errhandler} )
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Create entity delegate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> sd = root.delegate()
  sd.log = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> args = [<span class="hljs-string">'entity'</span>]
    root.log.apply(<span class="hljs-keyword">this</span>,args.concat(arr(<span class="hljs-built_in">arguments</span>)))
  }
  logging.makelogfuncs(sd)</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Template entity that makes all others.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  private$.entity = make_entity({},sd)

  private$.exports.Entity = make_entity.Entity</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>DEPRECATED
for use with async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.next_act = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> si   = <span class="hljs-keyword">this</span> || root
    <span class="hljs-keyword">var</span> args = arr(<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next</span>) </span>{
      args.push(next)
      si.act.apply(si,args)
    }
  }



  root.gate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> gated = <span class="hljs-keyword">this</span>.delegate({gate$:<span class="hljs-literal">true</span>})
    <span class="hljs-keyword">return</span> gated
  }


  root.ungate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> ungated = <span class="hljs-keyword">this</span>.delegate({gate$:<span class="hljs-literal">false</span>})
    <span class="hljs-keyword">return</span> ungated
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Add builtin actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.add( {role:<span class="hljs-string">'seneca'</span>, cmd:<span class="hljs-string">'stats'</span>},   action_seneca_stats )
  root.add( {role:<span class="hljs-string">'seneca'</span>, cmd:<span class="hljs-string">'close'</span>},   action_seneca_close )
  root.add( {role:<span class="hljs-string">'seneca'</span>, info:<span class="hljs-string">'ready'</span>},  action_seneca_ready )
  root.add( {role:<span class="hljs-string">'seneca'</span>, info:<span class="hljs-string">'fatal'</span>},  action_seneca_fatal )
  root.add( {role:<span class="hljs-string">'seneca'</span>, get:<span class="hljs-string">'options'</span>}, action_options_get  )</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Legacy builtin actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  root.add( {role:<span class="hljs-string">'seneca'</span>,  stats:<span class="hljs-literal">true</span>},  action_seneca_stats )
  root.add( {role:<span class="hljs-string">'seneca'</span>,  ready:<span class="hljs-literal">true</span>},  action_seneca_ready )
  root.add( {role:<span class="hljs-string">'options'</span>, cmd:<span class="hljs-string">'get'</span>},   action_options_get  )

  cmdline.handle( root, argv )</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Define builtin actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_fatal</span>(<span class="hljs-params">args,done</span>) </span>{
    done()
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_close</span>(<span class="hljs-params">args,done</span>) </span>{
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'close'</span>)
    done()
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_ready</span>(<span class="hljs-params">args,done</span>) </span>{
    private$.wait_for_ready = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'ready'</span>)
    done()
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_seneca_stats</span>(<span class="hljs-params"> args, done </span>) </span>{
    <span class="hljs-keyword">var</span> stats

    <span class="hljs-keyword">if</span>( args.pattern &amp;&amp; private$.stats.actmap[args.pattern] ) {
      stats = private$.stats.actmap[args.pattern]
      stats.time = private$.timestats.calculate(args.pattern)
    }
    <span class="hljs-keyword">else</span> {
      stats = _.clone(private$.stats)
      stats.now    = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      stats.uptime = stats.now - stats.start

      stats.now   = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(stats.now).toISOString()
      stats.start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(stats.start).toISOString()

      <span class="hljs-keyword">var</span> summary =
            (<span class="hljs-literal">null</span> == args.summary &amp;&amp; <span class="hljs-literal">false</span>) ||
            (<span class="hljs-regexp">/^false$/i</span>.exec(args.summary) ? <span class="hljs-literal">false</span> : !!(args.summary) )

      <span class="hljs-keyword">if</span>( summary ) {
        stats.actmap = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>
      }
      <span class="hljs-keyword">else</span> {
        _.each( private$.stats.actmap, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a,p</span>) </span>{
          private$.stats.actmap[p].time = private$.timestats.calculate(p)
        })
      }
    }

    done(<span class="hljs-literal">null</span>,stats)
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action_options_get</span>(<span class="hljs-params"> args, done </span>) </span>{
    <span class="hljs-keyword">var</span> options = private$.optioner.get()

    <span class="hljs-keyword">var</span> base = args.base || <span class="hljs-literal">null</span>
    <span class="hljs-keyword">var</span> root = base ? (options[base]||{}) : options
    <span class="hljs-keyword">var</span> val  = args.key ? root[args.key] : root

    done(<span class="hljs-literal">null</span>,common.copydata(val))
  }


  _.each( so.internal.close_signals, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">active,signal</span>)</span>{
    <span class="hljs-keyword">if</span>(active) {
      process.on(signal,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        root.close(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
          <span class="hljs-keyword">if</span>( err ) <span class="hljs-built_in">console</span>.error(err);
          process.exit( err ? (<span class="hljs-literal">null</span> == err.exit ? <span class="hljs-number">1</span> : err.exit) : <span class="hljs-number">0</span> )
        })
      })
    }
  })


  <span class="hljs-keyword">return</span> root
}</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Utilities</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makedie</span>(<span class="hljs-params"> instance, ctxt </span>) </span>{
  ctxt = _.extend(ctxt,instance.die?instance.die.context:{})

  <span class="hljs-keyword">var</span> die = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> err </span>) </span>{
    <span class="hljs-keyword">var</span> die_trace = <span class="hljs-string">'\n'</span>+(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'die trace'</span>).stack)
          .match(<span class="hljs-regexp">/^.*?\n.*\n(.*)/</span>)[<span class="hljs-number">1</span>]

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span>( !err ) {
        err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( <span class="hljs-string">'unknown'</span> )
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !util.isError(err) ) {
        err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( _.isString(err) ? err : util.inspect(err) )
      }

      err.fatal$ = <span class="hljs-literal">true</span>

      <span class="hljs-keyword">var</span> so = instance.options()</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>undead is only for testing, do not use in production</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> undead = so.debug.undead || (err &amp;&amp; err.undead)

      <span class="hljs-keyword">var</span> logargs = [ctxt.type, ctxt.plugin, ctxt.tag, ctxt.id,
                     err.code, err.message, err.details,
                     instance.fixedargs.fatal$?<span class="hljs-string">'all-errors-fatal'</span>:<span class="hljs-string">'-'</span>,
                     ctxt.callpoint()]

      instance.log.fatal.apply( instance, logargs )

      <span class="hljs-keyword">var</span> stack = err.stack || <span class="hljs-string">''</span>
      stack = stack.replace(<span class="hljs-regexp">/^.*?\n/</span>,<span class="hljs-string">'\n'</span>)

      <span class="hljs-keyword">var</span> procdesc = <span class="hljs-string">'\n  pid='</span>+process.pid+
            <span class="hljs-string">', arch='</span>+process.arch+
            <span class="hljs-string">', platform='</span>+process.platform+
            <span class="hljs-string">',\n  path='</span>+process.execPath+
            <span class="hljs-string">',\n  argv='</span>+util.inspect(process.argv).replace(<span class="hljs-regexp">/\n/g</span>,<span class="hljs-string">''</span>)+
            <span class="hljs-string">',\n  env='</span>+util.inspect(process.env).replace(<span class="hljs-regexp">/\n/g</span>,<span class="hljs-string">''</span>)

      <span class="hljs-keyword">var</span> fatalmodemsg = instance.fixedargs.fatal$ ?
            <span class="hljs-string">'\n  ALL ERRORS FATAL: action called with argument fatal$:true '</span>+
            <span class="hljs-string">'(probably a plugin init error, or using a plugin seneca instance'</span>+
            <span class="hljs-string">', see senecajs.org/fatal.html)'</span> : <span class="hljs-string">''</span>

      <span class="hljs-keyword">var</span> stderrmsg =
            <span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Seneca Fatal Error\n"</span>+
            <span class="hljs-string">"==================\n\n"</span>+
            <span class="hljs-string">"Message: "</span>+err.message+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Code: "</span>+err.code+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Details: "</span>+util.inspect(err.details,{depth:<span class="hljs-literal">null</span>})+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Stack: "</span>+stack+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Instance: "</span>+instance.toString()+fatalmodemsg+die_trace+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"When: "</span>+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Log: "</span>+jsonic.stringify(logargs)+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Node:\n  "</span>+util.inspect(process.versions).replace(<span class="hljs-regexp">/\s+/g</span>,<span class="hljs-string">' '</span>)+
            <span class="hljs-string">",\n  "</span>+util.inspect(process.features).replace(<span class="hljs-regexp">/\s+/g</span>,<span class="hljs-string">' '</span>)+
            <span class="hljs-string">",\n  "</span>+util.inspect(process.moduleLoadList).replace(<span class="hljs-regexp">/\s+/g</span>,<span class="hljs-string">' '</span>)+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Process: "</span>+procdesc+<span class="hljs-string">"\n\n"</span>


      <span class="hljs-keyword">if</span>( so.errhandler ) {
        so.errhandler.call(instance,err)
      }

      <span class="hljs-keyword">if</span>( instance.closed ) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">if</span>( !undead ) {
        instance.act(<span class="hljs-string">'role:seneca,info:fatal,closing$:true'</span>,{err:err})

        instance.close(</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>terminate process, err (if defined) is from seneca.close</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> err </span>) </span>{
            <span class="hljs-keyword">if</span>( !undead ) {
              process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span>( err ) console_error( err );
                console_error( stderrmsg )
                console_error(<span class="hljs-string">"\n\nSENECA TERMINATED at "</span>+(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())+
                              <span class="hljs-string">". See above for error report.\n\n"</span>)
                process.exit(<span class="hljs-number">1</span>)
              })
            }
          }
        )
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>make sure we close down within options.deathdelay seconds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( !undead ) {
        <span class="hljs-keyword">var</span> killtimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          console_error( stderrmsg )
          console_error(<span class="hljs-string">"\n\nSENECA TERMINATED (on timeout) at "</span>+
                        (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())+<span class="hljs-string">".\n\n"</span>)
          process.exit(<span class="hljs-number">2</span>);
        }, so.deathdelay);
        killtimer.unref();
      }
    }
    <span class="hljs-keyword">catch</span>(panic) {
      <span class="hljs-keyword">var</span> msg =
            <span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Seneca Panic\n"</span>+
            <span class="hljs-string">"============\n\n"</span>+
            panic.stack+
            <span class="hljs-string">"\n\nOriginal Error:\n"</span>+
            (<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] &amp;&amp; <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>].stack ? <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>].stack : <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>])
      console_error(msg)
    }
  }

  die.context = ctxt

  <span class="hljs-keyword">return</span> die
}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_trace_act</span>(<span class="hljs-params"> opts </span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>)
    args.unshift(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())

    <span class="hljs-keyword">if</span>( opts.stack ) {
      args.push(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'trace...'</span>).stack)
    }

    console_log(args.join(<span class="hljs-string">'\t'</span>))
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pin_patrun_customizer</span>(<span class="hljs-params">pat,data</span>) </span>{
  <span class="hljs-comment">/* jshint validthis:true */</span>

  <span class="hljs-keyword">var</span> pi = <span class="hljs-keyword">this</span>

  <span class="hljs-keyword">var</span> gexers = {}
  _.each(pat, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,k</span>) </span>{
    <span class="hljs-keyword">if</span>( _.isString(v) &amp;&amp; ~v.indexOf(<span class="hljs-string">'*'</span>) ) {
      <span class="hljs-keyword">delete</span> pat[k]
      gexers[k] = gex(v)
    }
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>handle previous patterns that match this pattern</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> prev     = pi.list(pat)
  <span class="hljs-keyword">var</span> prevfind = prev[<span class="hljs-number">0</span>] &amp;&amp; prev[<span class="hljs-number">0</span>].find
  <span class="hljs-keyword">var</span> prevdata = prev[<span class="hljs-number">0</span>] &amp;&amp; pi.findexact(prev[<span class="hljs-number">0</span>].match)

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args,data</span>) </span>{
    <span class="hljs-keyword">var</span> pi  = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> out = data
    _.each(gexers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">g,k</span>) </span>{
      <span class="hljs-keyword">var</span> v = args[k]
      <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == g.on( v ) ) { out = <span class="hljs-literal">null</span> }
    })

    <span class="hljs-keyword">if</span>( prevfind &amp;&amp; <span class="hljs-literal">null</span> == out ) {
      out = prevfind.call(pi,args,prevdata)
    }

    <span class="hljs-keyword">return</span> out
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Primary export function, creates a new Seneca instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"> seneca_options, more_options </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Create instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> seneca = make_seneca( _.extend( {}, seneca_options, more_options ))
  <span class="hljs-keyword">var</span> so     = seneca.options()</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Register default plugins, unless turned off by options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( so.default_plugins.basic )        { seneca.use(<span class="hljs-string">'basic'</span>) }
  <span class="hljs-keyword">if</span>( so.default_plugins.transport )    { seneca.use(<span class="hljs-string">'transport'</span>) }
  <span class="hljs-keyword">if</span>( so.default_plugins.web )          { seneca.use(<span class="hljs-string">'web'</span>) }
  <span class="hljs-keyword">if</span>( so.default_plugins[<span class="hljs-string">'mem-store'</span>] ) { seneca.use(<span class="hljs-string">'mem-store'</span>) }</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Register plugins specified in options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(so.plugins, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">plugindesc</span>) </span>{
    seneca.use(plugindesc)
  })

  <span class="hljs-keyword">return</span> seneca
}</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>To reference builtin loggers when defining logging options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>init.loghandler = logging.handlers</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Makes require(‘seneca’).use( … ) work by creating an on-the-fly instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>init.use = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> instance = init()
  <span class="hljs-keyword">return</span> instance.use.apply(instance,arr(<span class="hljs-built_in">arguments</span>))
}</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Mostly for testing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>( <span class="hljs-built_in">require</span>.main === <span class="hljs-built_in">module</span> ) {
  init()
}</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <h3 id="declarations">Declarations</h3>

            </div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Seneca is an EventEmitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Seneca</span>(<span class="hljs-params"></span>) </span>{
  events.EventEmitter.call(<span class="hljs-keyword">this</span>)
  <span class="hljs-keyword">this</span>.setMaxListeners(<span class="hljs-number">0</span>)
}
util.inherits(Seneca, events.EventEmitter)</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Private member variables of Seneca object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_private</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> {
    stats: {
      start: <span class="hljs-built_in">Date</span>.now(),
      act: {
        calls: <span class="hljs-number">0</span>,
        done:  <span class="hljs-number">0</span>,
        fails: <span class="hljs-number">0</span>,
        cache: <span class="hljs-number">0</span>
      },
      actmap:{}
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Make parambulators.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>function make_paramcheck() {
  var paramcheck = {}

  paramcheck.options = parambulator({
    tag:        { string$:true },
    idlen:      { integer$:true },
    timeout:    { integer$:true },
    errhandler: { function$:true },
  },{
    topname:       'options',
    msgprefix:     'seneca( {...} ): ',
  })

  paramcheck.register = parambulator({
    type$:     'object',
    required$: ['name','init'],
    string$:   ['name'],
    function$: ['init','service'],
    object$:   ['options']
  },{
    topname:       'plugin',
    msgprefix:     'register(plugin): ',
  })

  return paramcheck
}</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Minor utils</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thrower</span>(<span class="hljs-params">err</span>) </span>{
  <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">throw</span> err;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Callpoint resolver. Indicates location in calling code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_callpoint</span>(<span class="hljs-params"> active </span>) </span>{
  <span class="hljs-keyword">if</span>( active ) { 
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> error.callpoint(
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(),
        [<span class="hljs-string">'/seneca/seneca.js'</span>,<span class="hljs-string">'/seneca/lib/'</span>, <span class="hljs-string">'/lodash.js'</span>] )
    } 

  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> _.noop;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>For backwards compatibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_legacy_fail</span>(<span class="hljs-params">so</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> args = common.arrayify(<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> cb = _.isFunction(<span class="hljs-built_in">arguments</span>[<span class="hljs-built_in">arguments</span>.length-<span class="hljs-number">1</span>]) ?
          <span class="hljs-built_in">arguments</span>[<span class="hljs-built_in">arguments</span>.length-<span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>

    <span class="hljs-keyword">if</span>( cb ) {
      args.pop()
    }

    <span class="hljs-keyword">if</span>( _.isObject( args[<span class="hljs-number">0</span>] ) ) {
      <span class="hljs-keyword">var</span> code = args[<span class="hljs-number">0</span>].code
      <span class="hljs-keyword">if</span>( _.isString(code) ) {
        args.unshift(code)
      }
    }

    <span class="hljs-keyword">var</span> err = error.apply(<span class="hljs-literal">null</span>,args)
    err.callpoint = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>().stack.match(<span class="hljs-regexp">/^.*\n.*\n\s*(.*)/</span>)[<span class="hljs-number">1</span>]
    err.seneca = { code: err.code, valmap:err.details }

    <span class="hljs-keyword">this</span>.log.error(err)
    <span class="hljs-keyword">if</span>( so.errhandler ) {
      so.errhandler.call(<span class="hljs-keyword">this</span>,err)
    }

    <span class="hljs-keyword">if</span>( cb ) {
      cb.call(<span class="hljs-keyword">this</span>,err)
    }

    <span class="hljs-keyword">return</span> err;
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>Error code messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ERRMSGMAP</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> {
    test_msg: <span class="hljs-string">'Test message.'</span>,

    test_prop: <span class="hljs-string">'TESTING: exists: &lt;%=exists%&gt;, notfound:&lt;%=notfound%&gt;, str=&lt;%=str%&gt;,'</span>+
      <span class="hljs-string">' obj=&lt;%=obj%&gt;, arr=&lt;%=arr%&gt;, bool=&lt;%=bool%&gt;, null=&lt;%=null$%&gt;, delete=&lt;%=delete$%&gt;, undefined=&lt;%=undefined$%&gt;, void=&lt;%=void$%&gt;, NaN=&lt;%=NaN$%&gt;'</span>,

    add_string_pattern_syntax: <span class="hljs-string">'Could not add action due to syntax error in '</span>+
      <span class="hljs-string">'pattern string: "&lt;%=argstr%&gt;": Line:&lt;%=line%&gt;, Column:&lt;%=col%&gt;; &lt;%=syntax%&gt;'</span>,

    act_string_args_syntax: <span class="hljs-string">'Could execute action due to syntax error in argument'</span>+
      <span class="hljs-string">' string: "&lt;%=argstr%&gt;": Line:&lt;%=line%&gt;, Column:&lt;%=col%&gt;; &lt;%=syntax%&gt;'</span>,

    add_pattern_object_expected_after_string_pattern: <span class="hljs-string">'Could not add action; '</span>+
      <span class="hljs-string">'unexpected argument; a pattern object or function should follow the pattern'</span>+
      <span class="hljs-string">' string; arguments were: "&lt;%=args%&gt;".'</span>,

    add_pattern_object_expected: <span class="hljs-string">'Could not add action; unexpected argument; '</span>+
      <span class="hljs-string">'a pattern object or string should be the first argument; '</span>+
      <span class="hljs-string">'arguments were: "&lt;%=args%&gt;".'</span>,

    add_action_function_expected: <span class="hljs-string">'Could not add action: the action function '</span>+
      <span class="hljs-string">'should appear after the pattern; arguments were: "&lt;%=args%&gt;".'</span>,

    add_action_metadata_not_an_object: <span class="hljs-string">'Could not add action: the argument after '</span>+
      <span class="hljs-string">'the action function should be a metadata object: &lt;%=actmeta%&gt;.'</span>,

    add_empty_pattern: <span class="hljs-string">'Could not add action, as the action pattern is empty: '</span>+
      <span class="hljs-string">'"&lt;%=args%&gt;"'</span>,

    act_if_expects_boolean: <span class="hljs-string">'The method act_if expects a boolean value as its '</span>+
      <span class="hljs-string">'first argument, was: "&lt;%=first%&gt;".'</span>,

    act_not_found: <span class="hljs-string">'No matching action pattern found for &lt;%=args%&gt;, and no default '</span>+
      <span class="hljs-string">'result provided (using a default$ property).'</span>,

    act_default_bad: <span class="hljs-string">'No matching action pattern found for &lt;%=args%&gt;, and default '</span>+
      <span class="hljs-string">'result is not a plain object: &lt;%=xdefault%&gt;.'</span>,

    act_no_args: <span class="hljs-string">'No action pattern defined in "&lt;%=args%&gt;"; the first argument '</span>+
      <span class="hljs-string">'should be a string or object pattern.'</span>,

    act_invalid_args: <span class="hljs-string">'Action &lt;%=pattern%&gt; has invalid arguments; &lt;%=message%&gt;; '</span>+
      <span class="hljs-string">'arguments were: &lt;%=args%&gt;.'</span>,

    act_execute: <span class="hljs-string">'Action &lt;%=pattern%&gt; failed: &lt;%=message%&gt;.'</span>,

    act_callback: <span class="hljs-string">'Action &lt;%=pattern%&gt; callback threw: &lt;%=message%&gt;.'</span>,

    result_not_objarr: <span class="hljs-string">'Action &lt;%=pattern%&gt; responded with result that was not an '</span>+
      <span class="hljs-string">'object or array: &lt;%=result%&gt;; Use option strict:{result:false} to allow; '</span>+
      <span class="hljs-string">'arguments were: &lt;%=args%&gt;'</span>,

    no_client: <span class="hljs-string">'Transport client was not created; arguments were: "&lt;%=args%&gt;".'</span>,

    invalid_options: <span class="hljs-string">'Invalid options; &lt;%=message%&gt;'</span>,

    plugin_required: <span class="hljs-string">'The &lt;%=name%&gt; plugin depends on the &lt;%=dependency%&gt; plugin, '</span>+
      <span class="hljs-string">'which is not loaded yet.'</span>,

    plugin_init: <span class="hljs-string">'The &lt;%=name%&gt; plugin failed to initialize: &lt;%=plugin_error%&gt;.'</span>,

    plugin_init_timeout: <span class="hljs-string">'The &lt;%=name%&gt; plugin failed to initialize within '</span>+
      <span class="hljs-string">'&lt;%=timeout%&gt; milliseconds (The init:&lt;%=name%&gt; action did not call the "done"'</span>+
      <span class="hljs-string">' callback in time).'</span>,

    export_not_found: <span class="hljs-string">'The export &lt;%=key%&gt; has not been defined by a plugin.'</span>,

    store_cmd_missing: <span class="hljs-string">'Entity data store implementation is missing a command; '</span>+
      <span class="hljs-string">'"&lt;%=cmd%&gt;": "&lt;%=store%&gt;".'</span>,

    sub_function_catch: <span class="hljs-string">'Pattern subscription function threw: &lt;%=message%&gt; on '</span>+
      <span class="hljs-string">'args: &lt;%=args%&gt;, result: &lt;%=result%&gt;.'</span>,

    ready_failed: <span class="hljs-string">'Ready function failed: &lt;%=message%&gt;'</span>
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Intentional console output uses this function. Helps to find spurious debugging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">console_log</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-built_in">console</span>.log.apply(<span class="hljs-literal">null</span>,<span class="hljs-built_in">arguments</span>)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Intentional console errors use this function. Helps to find spurious debugging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">console_error</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-built_in">console</span>.error.apply(<span class="hljs-literal">null</span>,<span class="hljs-built_in">arguments</span>)
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
